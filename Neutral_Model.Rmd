# Multifractal patterns for spatial neutral simulacions based on Periphyton/BCI

Ten repeated simulations with chosen parameters

    BirthRate=1
    MortalityRate=0.2 
    DispersalDistance=2.0909 (12) - 2.2 (6) 
    ColonizationRate=0.01 - 0.001 
    ReplacementRate=0 0.1 0.5

    For ColonizationRate=0.001 &  DispersalDistance=2.0909
    ReplacementRate= 0.01 0.05 0.1 0.2 0.3 0.4 0.5 1
    
    Time = 1000 
    
    This combination of parameters is on file pomac00-10.lin
    
    
```{r simulPeriphyton, eval=FALSE}
rm(list = ls(all = TRUE))

source('Fun_Multi_patt.r')

setwd("Simul")
# copy the simulation file parameter file
system("cp pomac00-10.lin pomac.lin")

# change .par file to change simulation parameters
# 
#system("sed -i 's/bciExpZ/bciExpZ005/g' bci452Z.par")
#system("sed -i 's/per64Pow00-05/per64Pow500/g' per64JZ.par")
#system("sed -i 's/nEvals 100/nEvals 1000/g' per64JZ.par")

# Perform the simulations
system("./ipsNeutralCont per64JZ.par per64.inp")


setwd("..")

```

Analyze the time series to observe neutral /non-neutral behavior with H/S

```{r analyzePeri_HS}

sims <- readNeutral_timeSeries("Simul/per64Pow1000Density.txt")

require(plyr)
names(sims)
mean_sims <- ddply(sims, .(Time,DispersalDistance,ColonizationRate,
                  ReplacementRate),summarize, 
                  Dens = mean(Tot.Dens), 
                  SD.S=sd(S), 
                  S= mean(S),
                  SD.H= sd(H), 
                  H= mean(H)
                  )

require(ggplot2)

# All combinations of dispersal/colonization
mean_s1 <- with(mean_sims,mean_sims[(ReplacementRate==.1 | ReplacementRate==0.5 | ReplacementRate==0),])

mean_s1$DispersalDistance <- as.factor(mean_s1$DispersalDistance) 
levels(mean_s1$DispersalDistance)<-c(12,6)

gp <- ggplot(mean_s1, aes(x=Time, y=H, color=factor(ReplacementRate))) +
  geom_errorbar(aes(ymin=H-SD.H, ymax=H+SD.H), alpha=.1) +
  geom_line()+ scale_color_discrete(name = "Replacement")
gp  + facet_grid(DispersalDistance ~ ColonizationRate)
ggsave("figs/PeriSimul_H_Time_DispxCol.png",width=6,height=4)


gp <- ggplot(mean_s1, aes(x=Time, y=S, color=factor(ReplacementRate))) +
  geom_errorbar(aes(ymin=S-SD.S, ymax=S+SD.S), alpha=.1) +
  geom_line()+ scale_color_discrete(name = "Replacement")
gp  + facet_grid(DispersalDistance ~ ColonizationRate)
ggsave("figs/PeriSimul_S_Time_DispxCol.png",width=6,height=4)


# Select only one combination of parms to analyze change in ReplacementRate

mean_s1 <- with(mean_sims,mean_sims[DispersalDistance==2.0909 & ColonizationRate==0.001,])

gp <- ggplot(mean_s1, aes(x=Time, y=H, color=factor(ReplacementRate))) +
  geom_errorbar(aes(ymin=H-SD.H, ymax=H+SD.H), alpha=.1) +
  geom_line()+ scale_color_discrete(name = "Replacement")
#gp <- gp +  geom_ribbon(aes(ymin=S-SD.S, ymax=S+SD.S),fill="blue",alpha=.1) 
gp
ggsave("figs/PeriSimul_H_Time_Replace.png",width=6,height=4)

gp <- ggplot(mean_s1, aes(x=Time, y=S, color=factor(ReplacementRate))) +
  geom_errorbar(aes(ymin=S-SD.S, ymax=S+SD.S), alpha=.1) +
  geom_line()+ scale_color_discrete(name = "Replacement")
gp
ggsave("figs/PeriSimul_S_Time_Replace.png",width=6,height=4)



```

1) No hay variacion del patron con respecto a los parametros DispersalDistance
y ColonizationRate

2) Parece que siempre tiende al patron con replacementRate=1 lo unico que mas lento o mas rapido sengun el valor de este parametro

1) Evidencia de que a partir de replacemenRate=0.05 se empieza a diferenciar. 

2) El patron espacial no se estabilizó en 100 simulaciones ni aun para el completamente neutral

Cuando el parámetro cambia de 0.01 a 0.05 hay un cambio en la dinamica transitoria, en ese sentido es crítico.


```{r analyzePeri_Dq_Time1000}

# Read the simulations with same parameters

#
md1 <- readNeutral_calcDq("Simul/per64Pow1000mfOrd.txt")

require(plyr)

d1_delta <- ddply(md1, .(DispersalDistance,ColonizationRate,
                  ReplacementRate,Time),summarize, 
                  DeltaDq = Dq[q==-5]-Dq[q==5], 
                  SD.DeltaDq=sqrt(SD.Dq[q==-5]^2+SD.Dq[q==5]^2),
                  D1=Dq[q==1],
                  SD.D1=SD.Dq[q==1]   )


# Only one combination of parameters with all points
#
mean_s1 <- with(d1_delta,d1_delta[DispersalDistance==2.0909 & ColonizationRate==0.001 & Time>10,])
gp <- ggplot(mean_s1, aes(x=Time, y=D1, color=factor(ReplacementRate))) +
  geom_point()+geom_smooth()+ scale_color_discrete(name = "Replacement")
gp          


gp <- ggplot(mean_s1, aes(x=Time, y=DeltaDq, color=factor(ReplacementRate))) +
  geom_point()+geom_smooth()+ scale_color_discrete(name = "Replacement")
gp          

# average the 10 simulations
d1_delta <- ddply(d1_delta, .(Time,DispersalDistance,ColonizationRate,
                  ReplacementRate),summarize, 
                  SD.D1=sd(D1), 
                  D1= mean(D1),
                  SD.DeltaDq= sd(DeltaDq), 
                  DeltaDq= mean(DeltaDq)
                  )

# Analysis of all combination dispersal/colonization
mean_s1 <- with(d1_delta,d1_delta[Time>10 & (ReplacementRate==0 | ReplacementRate==0.1 | ReplacementRate==0.5),])
mean_s1$DispersalDistance <- as.factor(mean_s1$DispersalDistance) 
levels(mean_s1$DispersalDistance)<-c(12,6)

gp <- ggplot(mean_s1, aes(x=Time, y=D1, color=factor(ReplacementRate)))
gp <- gp +  geom_errorbar(aes(ymin=D1-SD.D1, ymax=D1+SD.D1),alpha=.1) 
gp <- gp +  geom_line()+scale_color_discrete(name = "Replacement")
gp  + facet_grid(DispersalDistance ~ ColonizationRate)
ggsave("figs/PeriSimul_D1_Time_DispxCol.png",width=6,height=4)


# Analisis of one combination dispersal/colonization with variation on ReplacementRate
mean_s1 <- with(d1_delta,d1_delta[DispersalDistance==2.0909 & ColonizationRate==0.001 & Time>10,])

require(ggplot2)

gp <- ggplot(mean_s1, aes(x=Time, y=D1, color=factor(ReplacementRate)))
gp <- gp +  geom_errorbar(aes(ymin=D1-SD.D1, ymax=D1+SD.D1),alpha=.1) 
gp <- gp +  geom_line()+scale_color_discrete(name = "Replacement")
#  geom_point()+geom_smooth()+ scale_color_discrete(name = "Replacement")
gp          
ggsave("figs/PeriSimul_D1_Time_Replace.png",width=6,height=4)

gp <- ggplot(mean_s1, aes(x=Time, y=DeltaDq, color=factor(ReplacementRate))) 
gp <- gp +  geom_errorbar(aes(ymin=DeltaDq-SD.DeltaDq, ymax=DeltaDq+SD.DeltaDq),alpha=.1) 
gp <- gp +  geom_line()+scale_color_discrete(name = "Replacement")
gp          
ggsave("figs/PeriSimul_DeltaDq_Time_Replace.png",width=6,height=4)


```

Let's see if the time to maxima have critical behaviour
```{r analyzePeri_HMax}

mean_s1 <- with(sims,sims[DispersalDistance==2.0909 & ColonizationRate==0.001 & ReplacementRate>0.001,])
 
r1 <-length(levels(as.factor(mean_s1$Time)))
r2 <-length(levels(as.factor(mean_s1$ReplacementRate)))

mean_s1$rep <- rep(1:10,each=r1,times=r2)

mean_s2 <- ddply(mean_s1, .(ReplacementRate,rep),summarize, 
                  H=max(H), 
                  S=max(S)
                 )
# then simply merge with the original
mean_max <- merge(mean_s1,mean_s2,by=c("H","rep"))

gp <- ggplot(mean_max, aes(y=Time, x=ReplacementRate.x)) 
gp <- gp +  geom_point()+xlab("Replacement")+ylab("Time Max H")
gp <- gp +scale_x_log10()+scale_y_log10() 
gp +geom_smooth(method="lm") 
ggsave("figs/PeriSimul_TimeMaxHxReplace.png",width=6,height=4)



```

El tiempo del maximo en H aumenta de forma potencial a medidad que disminuye replacementRate y a medida que esta tasa es menor aumenta el tiempo en llegar al estado estacionario, pero cuando es cero el tiempo es el menor de todos.


Ahora vamos a hacer las simulaciones para una comunidad tipo BCI

```{r simulBCI_500, eval=FALSE}

setwd("Simul")
# copy the simulation file parameter file
system("cp pomac00-10.lin pomac.lin")


# change the output file
#system("sed -i 's/per64Pow00-05/per64Pow500/g' per64JZ.par")
#system("sed -i 's/nEvals 100/nEvals 500/g' per64JZ.par")

# Perform the simulations
system("./ipsNeutralCont bci452JZ.par bci452.inp")

setwd("..")

```

Analizamos que sucede con BCI 3 niveles de replacementRate y dos niveles de los otros parametros con respecto a H y S

```{r BCI_H_S_Dq_Time500}

sims <- readNeutral_timeSeries("Simul/bciPow500Density.txt")

require(plyr)
names(sims)
mean_sims <- ddply(sims, .(Time,DispersalDistance,ColonizationRate,
                  ReplacementRate),summarize, 
                  Dens = mean(Tot.Dens), 
                  SD.S=sd(S), 
                  S= mean(S),
                  SD.H= sd(H), 
                  H= mean(H)
                  )

require(ggplot2)

mean_s1 <- with(mean_sims,mean_sims[ReplacementRate==0 | ReplacementRate==0.1 | ReplacementRate==0.5,])

# Replace the values of dispersal parameter by means!

gp <- ggplot(mean_s1, aes(x=Time, y=H, color=factor(ReplacementRate))) +
  geom_line()+scale_color_discrete(name = "Replacement")
gp  + facet_grid(DispersalDistance ~ ColonizationRate)
ggsave("figs/BCISimul_H_Time_DispxCol.png",width=6,height=4)

gp <- ggplot(mean_s1, aes(x=Time, y=S, color=factor(ReplacementRate))) 
gp <- gp +  geom_line()+scale_color_discrete(name = "Replacement")
gp  + facet_grid(DispersalDistance ~ ColonizationRate)
ggsave("figs/BCISimul_S_Time_DispxCol.png",width=6,height=4)


#mean_sims <- with(mean_sims,mean_sims[DispersalDistance==2.0909 & ColonizationRate==0.001,])

# Now read the Dq output

md1 <- readNeutral_calcDq("Simul/bciPow500mfOrd.txt")

require(plyr)

d1_delta <- ddply(md1, .(DispersalDistance,ColonizationRate,
                  ReplacementRate,Time),summarize, 
                  DeltaDq = Dq[q==-5]-Dq[q==5], 
                  SD.DeltaDq=sqrt(SD.Dq[q==-5]^2+SD.Dq[q==5]^2),
                  D1=Dq[q==1],
                  SD.D1=SD.Dq[q==1]   )


d1_delta <- ddply(d1_delta, .(Time,DispersalDistance,ColonizationRate,
                  ReplacementRate),summarize, 
                  SD.D1=sd(D1), 
                  D1= mean(D1),
                  SD.DeltaDq= sd(DeltaDq), 
                  DeltaDq= mean(DeltaDq)
                  )

mean_s1 <- with(d1_delta,d1_delta[Time>10 & (ReplacementRate==0 | ReplacementRate==0.1 | ReplacementRate==0.5),])

gp <- ggplot(mean_s1, aes(x=Time, y=D1, color=factor(ReplacementRate))) +
  geom_line()+scale_color_discrete(name = "Replacement")
gp  + facet_grid(DispersalDistance ~ ColonizationRate)

ggsave("figs/BCISimul_D1_Time_DispxCol.png",width=6,height=4)


             
```

Al analizar con más especies se nota mucho la diferencia que produce en S  un mayor ColonizationRate, lo cual apenas se nota en H. H es muy sensible a replacementRate por lo que valores bajos del parametro producen grandes cambios. Para S el cambio con respecto a replacementRate es mas gradual, entonces si queremos detectar la presencia de procesos de nicho es mejor usar H.
Tambien D1 es muy sensible al ColonizationRate. Cuando Colonization es alto Neutral y No neutral se parecen, intermedios se diferencian.

Analizamos que sucede con BCI 3 niveles de replacementRate y dos niveles de los otros parametros con respecto a H y S

```{r BCI_H_S_Dq_Time500_Replacement}

sims <- readNeutral_timeSeries("Simul/bciPow500Density.txt")

require(plyr)
names(sims)
mean_sims <- ddply(sims, .(Time,DispersalDistance,ColonizationRate,
                  ReplacementRate),summarize, 
                  Dens = mean(Tot.Dens), 
                  SD.S=sd(S), 
                  S= mean(S),
                  SD.H= sd(H), 
                  H= mean(H)
                  )

mean_sims <- with(mean_sims,mean_sims[DispersalDistance==2.0909 & ColonizationRate==0.001,])

require(ggplot2)

gp <- ggplot(mean_sims, aes(x=Time, y=H, color=factor(ReplacementRate))) +
  geom_line()+scale_color_discrete(name = "Replacement")
gp  
ggsave("figs/BCISimul_H_Time_Replace.png",width=6,height=4)

gp <- ggplot(mean_sims, aes(x=Time, y=S, color=factor(ReplacementRate))) 
gp <- gp +  geom_line()+scale_color_discrete(name = "Replacement")
gp
ggsave("figs/BCISimul_S_Time_Replace.png",width=6,height=4)


# Now read the Dq output

md1 <- readNeutral_calcDq("Simul/bciPow500mfOrd.txt")


require(plyr)

d1_delta <- ddply(md1, .(Time,DispersalDistance,ColonizationRate,
                  ReplacementRate),summarize, 
                  DeltaDq = Dq[q==-5]-Dq[q==5], 
                  SD.DeltaDq=sqrt(SD.Dq[q==-5]^2+SD.Dq[q==5]^2),
                  D1=Dq[q==1],
                  SD.D1=SD.Dq[q==1]
)

# Before means I bind to sims to relate D1 vs H/S
sims <- cbind(sims,d1_delta[,7:8])

d1_delta <- ddply(d1_delta, .(Time,DispersalDistance,ColonizationRate,
                  ReplacementRate),summarize, 
                  SD.D1=sd(D1), 
                  D1= mean(D1),
                  SD.DeltaDq= sd(DeltaDq), 
                  DeltaDq= mean(DeltaDq)
                  )

mean_s1 <- with(d1_delta,d1_delta[DispersalDistance==2.0909 & ColonizationRate==0.001 & Time>10,])
require(ggplot2)
gp <- ggplot(mean_s1, aes(x=Time, y=D1, color=factor(ReplacementRate))) +
  geom_line()+scale_color_discrete(name = "Replacement")
gp  

ggsave("figs/BCISimul_D1_Time_Replace.png",width=6,height=4)

# How is the relation D1-H D1-S
mean_sims <- with(sims,sims[DispersalDistance==2.0909 & ColonizationRate==0.001 & Time==150 & (ReplacementRate==.01 | ReplacementRate==0.5 | ReplacementRate==0),])

gp <- ggplot(mean_sims, aes(x=D1, y=H )) +
  geom_point()
gp + facet_grid(. ~ ReplacementRate)+  geom_smooth(method="lm")


gp <- ggplot(mean_sims, aes(x=D1, y=S )) +
  geom_point()
gp
gp + facet_grid(. ~ ReplacementRate)+  geom_smooth(method="lm")

# D1 la relacion cambia de acuerdo al en que parte de la curva estemos. Si la H o S esta aumentando en el tiempo o si esta bajando puede ser positiva o negativa HAY QUE EXPLORAR MAS 

```

Vemos que pasa con la diversidad H en el tiempo en el experimento de perifiton
1999

```{r calcPerDiversity}
# Read from original data for Dates
#
sp <- read.table("Data/Peri1999_EspeciesAbundance.txt", header=T)

#require(vegan)
#richPer <- data.frame(diversity(sp[,3:66]),specnumber(sp[,3:66]))
#names(richPer)<- c("H","S")
#richPer$Plate <- sp$Plate
#richPer$Time <- sp$Date - 990917 +3
#richPer$Aquaria <- with(richPer, substr(Plate,1,1))

# I have the periphyton's data already calculated 

richPer <- read.table("Data/richPer.dat", header=T)
nrow(richPer)
nrow(sp)
richPer$Time <- sp$Date - 990917 +3
richPer$Aquaria <- with(richPer, substr(Plate,1,1))
with(richPer,richPer[is.na(D1),])

# There are 2 plates with missing D1
# Check the images************************
#

require(plyr)
mean_rp  <- ddply(richPer, .(Time),summarize,
                  SD.H = sd(H),
                  H = mean(H),
                  SD.S = sd(S),
                  S = mean(S),
                  SD.D1=sd(D1),
                  D1 =mean(D1)
                  )
require(ggplot2)
gp <- ggplot(mean_rp, aes(x=Time, y=H)) +  geom_point()
gp <- gp +  stat_smooth(method="lm",formula = y ~ poly(x, 2),se=F)
gp <- gp +  geom_errorbar(aes(ymin=H-SD.H, ymax=H+SD.H),alpha=.1) 
gp  


ggsave("figs/Peri1999_H_Time.png",width=6,height=4)

gp <- ggplot(mean_rp, aes(x=Time, y=S)) + geom_point() #aes(colour = Aquaria))
gp <- gp +  stat_smooth(method="lm",formula = y ~ poly(x, 2),se=F)
gp <- gp +  geom_errorbar(aes(ymin=S-SD.S, ymax=S+SD.S),alpha=.1) 
gp  
#dev.off()

ggsave("figs/Peri1999_S_Time.png",width=6,height=4)

gp <- ggplot(mean_rp, aes(x=Time, y=D1)) + geom_point() #aes(colour = Aquaria))
gp <- gp +  stat_smooth(method="lm",formula = y ~ poly(x, 2),se=F)
gp <- gp +  geom_errorbar(aes(ymin=D1-SD.D1, ymax=D1+SD.D1),alpha=.1) 
gp  
ggsave("figs/Peri1999_D1_Time.png",width=6,height=4)


```

El peri esta en estado trasiente
Hay maximo de riqueza
H es creciente
Minimo de D1


# The critical transition between neutral and competitive communities 

## Calculation of the critical point using the probability of spanning cluster

I use here the following neutral model with power dispersal kernel:
en el $p_c$ 
<https://github.com/lsaravia/Neutral>

I generate parameter files for the simulation of neutral/hierarchical model using a uniform and a logseries metacommunity distribution  


```{r setup, eval=T }
load(".RData")
#simul  <- F # variable to perform or not the simulations

oldcd <-getwd()
source("R/Neutral_fun.r")

# Set the location of the binary 
#
neuBin <- "~/Dropbox/cpp/CaNew/Neutral/ipsNeutralPow"
neuBin64<- "~/Dropbox/cpp/CaNew/Neutral/ipsNeutralP64"


require(pander)
require(plyr)
require(dplyr)

panderOptions('table.split.table',Inf)
panderOptions('table.style', 'multiline')
options("scipen"=100, "digits"=6)
```

# Determination of the critical point using probability of spanning cluster

## Simulations for Uniform and Logseries side =128,192,256 species=64 1T=20000 


The critical probability is very low around 0.0005 thus most communities should be in a "niche" state but the transient time is very long unless rho is relatively high.



```{r gensimul_clu_side_64_meta40_T20000m0001, eval=F,echo=F,message=T,warning=T}
setwd("Simul")

m =  0.0001                  # Ver @Condit2012 
alfa=2.038974
side <- 256
nsp <- 64
nSimul <- 20

#ReplRate <- c(0.0000,0.0005,0.0006,0.0007,0.0008,0.0010,0.0011,0.0012,0.0013,0.0014,0.0015,0.0016,0.0017,0.0018,0.0019,0.0020,0.0022,0.0026,0.0028,0.0030,0.0040,0.0050,0.0060,0.0070,0.0090,0.0100,0.0150,0.0200,0.0500,0.1000,0.3000,1)

# Not done yet

ReplRate <- c(0.0000,0.0001,0.0002,0.0003,0.0004,0.0005,0.0006,0.0007,0.0008,0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070,0.0090,0.0100,0.0150,0.0200,0.0500,0.1000,0.3000,1)

time<-      c(20000,  20000, 20000, 30000, 30000, 30000, 30000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 10000,  5000,  5000,  5000,  5000,5000)

p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=c(128,192,256),meta=c("L","U")) 

time <-rep(time, times=nrow(p)/length(time))

p <-cbind(p,time)

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

Clu <- data.frame()
Clu <- foreach(i=1:nrow(p),.combine='rbind') %dopar%
{
    simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,T,"N",p$meta[i],F,2)
}

# To reconstruct the data frame Clusters from the output files  
#
# Clu <- data.frame()
# for(i in 1:nrow(p))
#   {
#   Clu <- rbind(Clu,simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,F,"N",p$meta[i]))
#   }


stopCluster(cl)

Clusters <-rbind(Clusters,Clu)
setwd(oldcd)

rm(cn,cl,Clu)

save.image()
```


# Calculation of the critical point T=20000 DispersalDistance=26 m=0.0001

```{r pcT20000_clu_side_64_meta30, eval=F,echo=F,message=T,warning=T}

m   <-0.0001
alfa <-round(2.03897,5)
side <- 256
nsp <- 64
nSimul <- 30
time <- 20000

require(plyr)
require(dplyr)

# Calculates critical probabilities for differnt side (rCTs) and critical probability for infinite lattices (rCT)
#
Clu <- filter(Clusters, Side!=64)
k <-calcCritical_prob(Clu,time,nsp,alfa,m)

require(ggplot2)
require(pander)

# Create data frame to store CP for lattices with different sides
rhoCritSide <- data_frame()

# Update table after recalculation of critical points
#
rhoCritSide <- bind_rows(rhoCritSide,k$rCTs)
pandoc.table(rhoCritSide,round=5)

# Create data frame to store CP for infinite lattices
rhoCrit <- data_frame()

# 
#rhoCrit <- filter(rhoCrit,DispersalDistance!=26.66 | ColonizationRate!=0.000159608 | MetaNsp!=64)
rhoCrit <- bind_rows(rhoCrit,k$rCT)
pandoc.table(rhoCrit,round=5)


plotCritical_Clusters(Clusters,time,nsp,alfa,m,rhoCritSide)


rm(k)

#
# Plots of SAD logseries and uniform metacommunity 
#
setwd("Simul")

m   <-0.0001
alfa <-round(2.03897,5)
time<-      c(20000,  20000, 30000, 30000, 20000, 20000, 20000,  5000, 5000)
ReplRate <- c(0.0000,0.0001,0.0003,0.0005,0.0010,0.0050,0.0100,0.1000,1)

options("scipen"=0, "digits"=4)

rank <- plotNeutral_SAD_1T(64,256,ReplRate,time,m,alfa,"L",T)
rank$MetaType="Logseries"
r1 <-  plotNeutral_SAD_1T(64,256,ReplRate,time,m,alfa,"U",T) 
r1$MetaType="Uniform"
rank <- rbind(rank,r1)
rank$Time <- 20000 
rm(r1)

options("scipen"=100, "digits"=6)
# require(RColorBrewer)
# mc <-brewer.pal(8,"Dark2")
colourCount = length(unique(rank$ReplacementRate))
# mc1 <- colorRampPalette(mc)(colourCount)
mc1 <-gg_color_hue(colourCount) 

mc1[3]<-"#0D0D0D" # rho=0.0003
g <- ggplot(rank,aes(x=Rank,y=Freq,colour=factor(ReplacementRate))) +  theme_bw() + scale_y_log10() 
g + scale_colour_manual(values=mc1,name=bquote("  "~rho))  + geom_point(size=0.5) +geom_line() + facet_grid(. ~ MetaType, scales="free_x" )

setwd(oldcd)
ggsave("figs/SAD_T20000_64_256_meta_m0001.png", width=6,height=4,units="in",dpi=600)

rm(rank,mc1)

```


## Simulations to Determine critical point for m=0.0001 Species=320 dispersal 26

m = Perimeter*DispersalDistance/(pi*Area),

```{r gensimul_clu_side_320_meta_T20000m0001, eval=T,echo=F,message=T,warning=T}
setwd("Simul")

                  # Ver @Condit2012 
m   <-0.0001
alfa=2.038974
side <- c(128,192,256)
nsp <- 320
nSimul <- 20

m_from_dispersalDistance(mean_power_opt(alfa),side)

ReplRate <- c(0.0000,0.0001,0.0002,0.0003,0.0004,0.0005,0.0006,0.0007,0.0008,0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070,0.0090,0.0100,0.0150,0.0200,0.0500,0.1000,0.3000,1)
time<-      c(20000,  20000, 20000, 30000, 30000, 30000, 30000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 10000,  5000,  5000,  5000,  5000,5000)

p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=c(128,192,256),meta=c("L","U")) 
time <-rep(time, times=nrow(p)/length(time))
p <-cbind(p,time)

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

Clu <- data.frame()
Clu <- foreach(i=1:nrow(p),.combine='rbind') %dopar%
{
    simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,T,"N",p$meta[i],F,2)
}

# To reconstruct the data frame Clusters from the output files  
#
# Clu <- data.frame()
# for(i in 1:nrow(p))
#   {
#   Clu <- rbind(Clu,simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,F,"N",p$meta[i]))
#   }


stopCluster(cl)

Clusters <-rbind(Clusters,Clu)
setwd(oldcd)

rm(cn,cl,Clu)

save.image()
```



## Calculation of the critical point T=20000 DispersalDistance=26 m=0.0001 no. species=320

```{r pcT20000_clu_side_320_meta_m0001, eval=F,echo=F,message=T,warning=T}

m   <-0.0001
alfa <-round(2.03897,5)
side <- 256
nsp <- 320
nSimul <- 20
time <- 20000

require(plyr)
require(dplyr)

# Calculates critical probabilities for differnt side (rCTs) and critical probability for infinite lattices (rCT)
#
k <-calcCritical_prob(Clusters,time,nsp,alfa,m)

require(ggplot2)
require(pander)

# Create data frame to store Critical Point for lattices with different sides
#
rhoCritSide <- bind_rows(rhoCritSide,k$rCTs)
pandoc.table(rhoCritSide,round=5)

# Create data frame to store CP for infinite lattices
#rhoCrit <- filter(rhoCrit,ColonizationRate!=m)
rhoCrit <- bind_rows(rhoCrit,k$rCT)
pandoc.table(rhoCrit,round=5)


plotCritical_Clusters(Clusters, time,nsp,alfa,m,rhoCritSide)

```

## Calculation of the critical point T=20000 DispersalDistance=26 m=0.1 no. species=320

```{r pcT20000_clu_side_320_meta_m1, eval=F,echo=F,message=T,warning=T}

m   <-0.1
alfa <-round(2.03897,5)
side <- 256
nsp <- 320
nSimul <- 20
time <- 20000

require(plyr)
require(dplyr)

# Calculates critical probabilities for differnt side (rCTs) and critical probability for infinite lattices (rCT)
#
Clu <- filter(Clusters, Side!=64)
k <-calcCritical_prob(Clu,time,nsp,alfa,m)

require(ggplot2)
require(pander)

# Update table after recalculation of critical points
#
#rhoCritSide <- filter(rhoCritSide,ColonizationRate!=m)

rhoCritSide <- bind_rows(rhoCritSide,k$rCTs)
pandoc.table(rhoCritSide,round=5)

# Create data frame to store Pc for infinite lattices
#
#rhoCrit <- filter(rhoCrit,ColonizationRate!=m)
rhoCrit <- bind_rows(rhoCrit,k$rCT)
pandoc.table(rhoCrit,round=5)


plotCritical_Clusters(Clusters, time,nsp,alfa,m,rhoCritSide)

```




## Determine critical point for m=0.01

```{r gensimul_clu_side_64_meta40_T20000m01, eval=F,echo=F,message=T,warning=T}
setwd("Simul")

m =  0.01                  # Ver @Condit2012 
alfa=2.038974
side <- 256
nsp <- 64
nSimul <- 40

ReplRate <- c(0.0000,0.0001,0.0005,0.0006,0.0007,0.0008,0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070,0.0080,0.0090,0.0100,0.0150,0.0200,0.0500,0.1000,0.3000,1) 


time<-      c(10000,  10000, 20000, 30000, 30000, 30000, 30000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 10000,  5000,  5000,  5000)


p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=c(128,192,256),meta=c("L","U")) 

time <-rep(time, times=nrow(p)/length(time))

p <-cbind(p,time)

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

Clu <- data.frame()
Clu <- foreach(i=1:nrow(p),.combine='rbind') %dopar%
{
    simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,T,"N",p$meta[i],F,2)
}

# To reconstruct the data frame Clusters from the output files  
#
# Clu <- data.frame()
# for(i in 1:nrow(p))
#   {
#   Clu <- rbind(Clu,simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,F,"N",p$meta[i]))
#   }


stopCluster(cl)

Clusters <-rbind(Clusters,Clu)
setwd(oldcd)

rm(cn,cl,Clu)

save.image()
```

## Calculation of the critical point T=20000 DispersalDistance=26 m=0.01

```{r pcT20000_clu_side_64_meta_m01, eval=F,echo=F,message=T,warning=T}

m   <-0.01
alfa <-round(2.03897,5)
side <- 256
nsp <- 64
nSimul <- 10
time <- 20000

require(plyr)
require(dplyr)

# Calculates critical probabilities for differnt side (rCTs) and critical probability for infinite lattices (rCT)
#
Clu <- filter(Clusters, Side!=64)
k <-calcCritical_prob(Clu,time,nsp,alfa,m)

require(ggplot2)
require(pander)

# Create data frame to store Pc for lattices with different sides
#rhoCritSide <- data_frame()

# Update CP tables after recalculation of critical points
#
rhoCritSide <- bind_rows(rhoCritSide,k$rCTs)
pandoc.table(rhoCritSide,round=5)

rhoCrit <- bind_rows(rhoCrit,k$rCT)
pandoc.table(rhoCrit,round=5)


plotCritical_Clusters(Clusters, time,nsp,alfa,m,rhoCritSide)


#
# Plots of SAD 
#
setwd("Simul")
options("scipen"=0, "digits"=4)
m   <-0.01
alfa <-round(2.03897,5)
ReplRate <- c(0.0000,0.0010,0.0050,0.0070,0.0100,0.0200,0.1000,0.3000,1)
time<-      c(10000 , 30000, 20000, 20000, 20000, 20000,  5000,  5000,  5000)

rank <- plotNeutral_SAD_1T(64,256,ReplRate,time,m,alfa,"L",T)
rank$MetaType="Logseries"
r1 <-  plotNeutral_SAD_1T(64,256,ReplRate,time,m,alfa,"U",T) 
r1$MetaType="Uniform"
rank <- rbind(rank,r1)
rank$Time <- 20000 
rm(r1)

options("scipen"=100, "digits"=6)
colourCount = length(unique(rank$ReplacementRate))
mc1 <-gg_color_hue(colourCount) 
mc1[4]<-"#0D0D0D" # rho=0.0015
g <- ggplot(rank,aes(x=Rank,y=Freq,colour=factor(ReplacementRate))) +  theme_bw() + scale_y_log10() 
g + scale_colour_manual(values=mc1,name=bquote("  "~rho))  + geom_point(size=0.5) +geom_line() + facet_grid(. ~ MetaType, scales="free_x" )

setwd(oldcd)
ggsave("figs/SAD_T20000_64_256_meta_m01.png", width=6,height=4,units="in",dpi=600)

rm(kk,k,k1,p,mClusters,tClusters,Clu,rank)
```


## Simulatios to Determine critical point for m=0.1

```{r gensimul_clu_side_64_meta_T20000m1, eval=F,echo=F,message=T,warning=T}
setwd("Simul")

m =  0.1                  # Ver @Condit2012 
alfa=2.038974
side <- 256
nsp <- 64
nSimul <- 50

ReplRate <- c(0.0000,0.0001,0.0005,0.0010,0.0050,0.0100,0.0200,0.0300, 0.0400, 0.0500, 0.0550, 0.0600, 0.0650, 0.0700, 0.0750, 0.0800, 0.0900,0.1000,0.3000,0.6000,0.9000,1) 
time<-      c(10000,  10000, 10000, 10000, 10000, 10000, 20000, 20000,  20000,  20000,  20000,  20000,  20000,  20000,  20000,  20000,   5000,  5000,  5000,  5000,  5000,5000)

p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=c(128,192,256),meta=c("L","U")) 

time <-rep(time, times=nrow(p)/length(time))

p <-cbind(p,time)

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

Clu <- data.frame()
Clu <- foreach(i=1:nrow(p),.combine='rbind') %dopar%
{
    simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,T,"N",p$meta[i],F,2)
}

# To reconstruct the data frame Clusters from the output files  
#
# Clu <- data.frame()
# for(i in 1:nrow(p))
#   {
#   Clu <- rbind(Clu,simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,F,"N",p$meta[i]))
#   }


stopCluster(cl)

setwd(oldcd)

rm(cn,cl,Clu)

save.image()
```

## Calculation of the critical point T=20000 DispersalDistance=26 m=0.1

```{r pcT20000_clu_side_64_meta_m1, eval=F,echo=F,message=T,warning=T}

m   <-0.1
alfa <-round(2.03897,5)
side <- 256
nsp <- 64
nSimul <- 50
time <- 20000

require(plyr)
require(dplyr)

# Calculates critical probabilities for differnt side (rCTs) and critical probability for infinite lattices (rCT)
#
Clu <- filter(Clusters, Side!=64)
k <-calcCritical_prob(Clu,time,nsp,alfa,m)

require(ggplot2)
require(pander)

# Update table after recalculation of critical points
#
#rhoCritSide <- filter(rhoCritSide,!(ColonizationRate==m & MetaNsp==nsp))

rhoCritSide <- bind_rows(rhoCritSide,k$rCTs)
pandoc.table(rhoCritSide,round=5)

# Create data frame to store Pc for infinite lattices
# rhoCrit <- filter(rhoCrit,!(ColonizationRate==m & MetaNsp==nsp))

rhoCrit <- bind_rows(rhoCrit,k$rCT)
pandoc.table(rhoCrit,round=5)
rhoCrit <- rhoCrit %>% arrange(DispersalDistance,MetaNsp,ColonizationRate,MetaType)


plotCritical_Clusters(Clusters, time,nsp,alfa,m,rhoCritSide)



#
# Plots of SAD 
#
setwd("Simul")
options("scipen"=0, "digits"=4)
m   <-0.1
alfa <-round(2.03897,5)
ReplRate <- c(0.0000,0.0010,0.0100,0.0500,0.0600,0.0700,0.1000,0.3000,1)
time<-      c(10000 , 10000, 10000, 20000, 20000, 20000,  5000,  5000,  5000)

rank <- plotNeutral_SAD_1T(64,256,ReplRate,time,m,alfa,"L",T)
rank$MetaType="Logseries"
r1 <-  plotNeutral_SAD_1T(64,256,ReplRate,time,m,alfa,"U",T) 
r1$MetaType="Uniform"
rank <- rbind(rank,r1)
rank$Time <- 20000 
rm(r1)

options("scipen"=100, "digits"=6)
colourCount = length(unique(rank$ReplacementRate))
mc1 <-gg_color_hue(colourCount) 
mc1[6]<-"#0D0D0D" # rho=0.0015
g <- ggplot(rank,aes(x=Rank,y=Freq,colour=factor(ReplacementRate))) +  theme_bw() + scale_y_log10() 
g + scale_colour_manual(values=mc1,name=bquote("  "~rho))  + geom_point(size=0.5) +geom_line() + facet_grid(. ~ MetaType, scales="free_x" )

setwd(oldcd)
ggsave("figs/SAD_T20000_64_256_meta_m1.png", width=6,height=4,units="in",dpi=600)

rm(kk,k,k1,p,mClusters,tClusters,Clu,rank)
save.image()
```


# Plots comparing different ColonizationRates H vs Rho side=256 

```{r plotCT_256_64_meta_T20000_m, eval=F,echo=F,message=T,warning=T}

m   <-0.1
alfa <-round(2.03897,5)
side <- 256
nsp <- 64
nSimul <- 50
time <- 20000

#
# Shannon diversity vs rho across ColonizationRate 
#
k<-filter(rhoCritSide,Time==time,MetaNsp==nsp,DispersalDistance==26.66,Side==256)
k$MetaType <- factor(k$MetaType,labels=c("Logseries","Uniform"))
tClusters <- Clusters %>% filter(MetaNsp==nsp,DispersalDistance==alfa,Side==256)  %>% mutate(MetaType=factor(MetaType,labels=c("Logseries","Uniform")))

#
# H vs rho
#
ggplot(tClusters, aes(x=ReplacementRate, y=H)) + geom_point(alpha=.1) + theme_bw() + scale_x_log10() + stat_summary(fun.y=median,geom="line",colour=colp[1])+ facet_grid(ColonizationRate ~ MetaType,scales="free_y" )+xlab(bquote(rho)) + geom_vline(aes(xintercept=pcrit),k,colour=colp[6])
ggsave("figs/HvsRepl_T20000_64_256_meta_m.png", width=6,height=6,units="in",dpi=600)

#
# H vs rho in linear x scale 
#
ggplot(tClusters, aes(x=ReplacementRate, y=H)) + geom_point(alpha=.1) + theme_bw() + coord_cartesian(xlim=c(0, 1)) + stat_summary(fun.y=median,geom="line",colour=colp[1])+ facet_grid(ColonizationRate ~ MetaType,scales="free_y" )+xlab(bquote(rho)) + geom_vline(aes(xintercept=pcrit),k,colour=colp[6]) + theme(panel.margin.x=unit(0.6, "lines"))
ggsave("figs/HvsRepl_T20000_64_256_meta_m_lin.png", width=6,height=6,units="in",dpi=600)


#
# Richness vs rho
#
ggplot(tClusters, aes(x=ReplacementRate, y=Richness)) + geom_point(alpha=.1) + theme_bw() + scale_x_log10() + stat_summary(fun.y=mean,geom="line",colour=colp[1])+ facet_grid(ColonizationRate ~ MetaType,scales="free_y") +xlab(bquote(rho)) + geom_vline(aes(xintercept=pcrit),k,colour=colp[6])
ggsave("figs/RichvsRepl_T20000_64_256_meta_m.png", width=6,height=6,units="in",dpi=600)

#
# Richness vs rho linear scale
#
ggplot(tClusters, aes(x=ReplacementRate, y=Richness)) + geom_point(alpha=.1) + theme_bw() + stat_summary(fun.y=mean,geom="line",colour=colp[1])+ facet_grid(ColonizationRate ~ MetaType,scales="free_y" )+xlab(bquote(rho)) + geom_vline(aes(xintercept=pcrit),k,colour=colp[6])
ggsave("figs/RichvsRepl_T20000_64_256_meta_m_lin.png", width=6,height=6,units="in",dpi=600)

```


## Regenerate Clusters data.frame from files in Simul folder DON'T RUN it without revision

```{r regen_clust_Side_64_meta_Time, eval=F,echo=F,message=T,warning=T}
setwd("Simul")

m    <-  0.0001
m    <-  0.01
m    <-  0.1
alfa <- 2.038974   # 26
alfa <- round(2.081069,5)   # 13
nsp  <- 64
nSimul<-100
require(dplyr)

# Count number of simulations
#
mClusters <- filter(Clusters, ColonizationRate==m,MetaNsp==nsp,DispersalDistance==alfa) %>% group_by(MetaNsp,Side,MetaType,ReplacementRate,DispersalDistance,ColonizationRate,Time) %>% summarise(n=n()) #%>% filter(n==50)

# Get ReplacementRates used in simulations
ReplRate <- unique(mClusters$ReplacementRate)

# Get sides used in simulations
side <- unique(mClusters$Side)

# For m=0.0001
#
# m    <-  0.0001
# ReplRate <- c(0.0000,0.0001,0.0002,0.0003,0.0004,0.0005,0.0006,0.0007,0.0008,0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070,0.0090,0.0100,0.0150,0.0200,0.0500,0.1000,0.3000,1)
# 
# time<-      c(20000,  20000, 20000, 30000, 30000, 30000, 30000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 10000,  5000,  5000,  5000,  5000,5000)

# For m=0.01
#
# m    <-  0.01
# ReplRate <- c(0.0000,0.0001,0.0005,0.0006,0.0007,0.0008,0.0010,0.0020,0.0030,0.0040,0.0050,0.0060,0.0070,0.0090,0.0100,0.0150,0.0200,0.0500,0.1000,0.3000,1)
# 
# time<-      c(10000,  10000, 20000, 30000, 30000, 30000, 30000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 20000, 10000,  5000,  5000,  5000)

m <- 0.1
ReplRate <- c(0.0000,0.0001,0.0005,0.0010,0.0050,0.0100,0.0200,0.0300, 0.0400, 0.0500, 0.0550, 0.0600, 0.0650, 0.0700, 0.0750, 0.0800, 0.0900,0.1000,0.3000,0.6000,0.9000,1) 
time<-      c(10000,  10000, 10000, 10000, 10000, 10000, 20000, 20000,  20000,  20000,  20000,  20000,  20000,  20000,  20000,  20000,   5000,  5000,  5000,  5000,  5000,5000)
side <- c(128,192,256)
p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=side,meta=c("L","U")) 
time <-rep(time, times=nrow(p)/length(time))
p <-cbind(p,time)

setwd("Simul")
nSimul<-100
Clu <- data.frame()
for(i in 1:nrow(p))
  {
  Clu <- rbind(Clu,simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,F,"N",p$meta[i]))
  }

# Count number of simulations
#
kk <-filter(Clu,ColonizationRate==m) %>% group_by(MetaNsp,Side,MetaType,ReplacementRate,DispersalDistance,Time) %>% summarise(n=n())  %>% filter(n<50)

kk1 <-filter(Clusters,ColonizationRate==m,MetaNsp==nsp) %>% group_by(MetaNsp,Side,MetaType,ReplacementRate,DispersalDistance,Time) %>% summarise(n=n()) %>% filter(n<50)

# Filter and replace
#
i<-23
kk1 <- filter(Clusters,ColonizationRate==m & MetaNsp==nsp & Side==256)

Clusters <- anti_join(Clusters,Clu)

Clusters <- filter(Clusters, !(ColonizationRate==m & MetaNsp==nsp & Side==256)) #%>% distinct()

Clusters <- bind_rows(Clusters, Clu)

setwd(oldcd)

# Filter some rho
#
# ReplRate <- c(0.0150,0.0250,0.0350,0.0450,0.45,0.7,0.8)
# Clusters <- filter(Clusters, !(ColonizationRate==m & ReplacementRate %in% ReplRate)) #%>% distinct()


# Filter simulations
#
#Clusters <- Clusters %>% filter(!(MetaNsp==nsp & DispersalDistance==alfa & ColonizationRate==m & Side==256 & ReplacementRate==0.1 & MetaType=="L"))
ReplRate <- c(0.0000,0.0005,0.0010,0.0050,0.0200,0.0300, 0.0600, 0.0650, 0.0750, 0.0900,0.1000,0.3000,0.6000) 

Clu <- Clusters %>% filter(MetaNsp==nsp & ColonizationRate==m & Side==256 & MetaType=="L" & (ReplacementRate %in% ReplRate))
ggplot(Clu,aes(H,colour=ReplacementRate)) + geom_freqpoly() +facet_wrap( ~ReplacementRate)+ guides(colour=FALSE)

rm(mClusters,p,kk,kk1,cn,cl,Clu,k,tClusters,rank)

save.image()


```


## Simulations to determine critical point, Time=20000 migration=0.1 dispersal=13

```{r gensimul_disp13_clu_side_64_meta_T20000m1, eval=F,echo=F,message=T,warning=T}

# Calculate dispersal parameter for half the mean distance from @Anand2010 DispersalDistance=13
#
# ana <- read.table("Data/Anand2010_DD.dat", header=T)
# m_DD <-mean(ana$DD)
# m_DD <- m_DD/2
# mean_power_opt <-function(alfa,x=1) abs(((alfa-1)/(alfa-2)*x)-m_DD)
# optimize(mean_power_opt,c(2,4))
# mean_power(2.081069)

setwd("Simul")

m <-  0.1
alfa <- 2.081069
side <- 512
nsp <- 64
nSimul <- 20

ReplRate <- c(0.0000,0.0001,0.0005,0.0010,0.0050,0.0100,0.0200,0.0300, 0.0400, 0.0500, 0.0550, 0.0600, 0.0650, 0.0700, 0.0750, 0.0800, 0.0900,0.1000,0.3000,0.6000,0.9000,1) 
time<-      c(10000,  10000, 10000, 10000, 10000, 10000, 20000, 20000,  20000,  20000,  20000,  20000,  20000,  20000,  20000,  20000,   5000,  5000,  5000,  5000,  5000,5000)

p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=c(128,192,256),meta=c("L","U")) 
time <-rep(time, times=nrow(p)/length(time))
p <-cbind(p,time)

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

Clu <- data.frame()
Clu <- foreach(i=1:nrow(p),.combine='rbind') %dopar%
{
    simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,T,"N",p$meta[i],F,2)
}

# To reconstruct the data frame Clusters from the output files  
#
# Clu <- data.frame()
# for(i in 1:nrow(p))
#   {
#   Clu <- rbind(Clu,simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,F,"N",p$meta[i]))
#   }


stopCluster(cl)

Clusters <-rbind(Clusters,Clu)
setwd(oldcd)

rm(cn,cl,Clu)

save.image()
```


## Calculation of the critical point T=20000 DispersalDistance=13 m=0.1 no. species=64

```{r pcT20000_disp13_clu_side_64_meta_m1, eval=F,echo=F,message=T,warning=T}

m <-  0.1
alfa <- round(2.081069,5)
side <- 256
nsp <- 64
time<-20000
nSimul <- 50
require(plyr)
require(dplyr)

# Calculates critical probabilities for differnt side (rCTs) and critical probability for infinite lattices (rCT)
#
Clusters <- filter(Clusters, Side!=64)
k <-calcCritical_prob(Clusters,time,nsp,alfa,m)

require(ggplot2)
require(pander)

# Update CP tables after recalculation of critical points
#
#rhoCritSide <- filter(rhoCritSide,ColonizationRate!=m)

rhoCritSide <- bind_rows(rhoCritSide,k$rCTs)
pandoc.table(rhoCritSide,round=5)

rhoCrit <- bind_rows(rhoCrit,k$rCT)
pandoc.table(rhoCrit,round=5)

plotCritical_Clusters(Clusters, time,nsp,alfa,m,rhoCritSide)


```

There seem to be no big changes in critical point with regard to dispersal distance 


## Simulations to determine critical point, Time=20000 migration=0.1 dispersal=52

```{r gensimul_disp52_clu_side_64_meta_T20000m1, eval=F,echo=F,message=T,warning=T}

# Calculate dispersal parameter for half the mean distance from @Anand2010 DispersalDistance=13
#
# ana <- read.table("Data/Anand2010_DD.dat", header=T)
# m_DD <-mean(ana$DD)
# m_DD <- m_DD*2
# mean_power_opt <-function(alfa,x=1) abs(((alfa-1)/(alfa-2)*x)-m_DD)
# optimize(mean_power_opt,c(2,4))
# mean_power(2.01911)

setwd("Simul")

m <-  0.1
alfa <- 2.01911
side <- 512
nsp <- 64
nSimul <- 50

ReplRate <- c(0.0000,0.0001,0.0005,0.0010,0.0050,0.0100,0.0200,0.0300, 0.0400, 0.0500, 0.0550, 0.0600, 0.0650, 0.0700, 0.0750, 0.0800, 0.0900,0.1000,0.3000,0.6000,0.9000,1) 
time<-      c(10000,  10000, 10000, 10000, 10000, 10000, 20000, 20000,  20000,  20000,  20000,  20000,  20000,  20000,  20000,  20000,   5000,  5000,  5000,  5000,  5000,5000)

p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=c(128,192,256),meta=c("L","U")) 
time <-rep(time, times=nrow(p)/length(time))
p <-cbind(p,time)

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

Clu <- data.frame()
Clu <- foreach(i=1:nrow(p),.combine='rbind') %dopar%
{
    simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,T,"N",p$meta[i],F,2)
}

# To reconstruct the data frame Clusters from the output files  
#
# Clu <- data.frame()
# for(i in 1:nrow(p))
#   {
#   Clu <- rbind(Clu,simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],nSimul,F,"N",p$meta[i]))
#   }


stopCluster(cl)

Clusters <-rbind(Clusters,Clu)
setwd(oldcd)

rm(cn,cl,Clu)

save.image()
```


## Simulations to Time=5000 with side=100-512, dispersal=26 migration=0.0001596079 species=16 

```{r simuldisp_clu_side512_meta16_n30_T5000, eval=F,echo=F,message=T,warning=T}
setwd("Simul")


side <- c(100,150) #c(100,150,256,512)
nsp <- 16
nSimul <- 30

ReplRate <- c(0.0000,0.0005,0.0006,0.0007,0.0008,0.0010,0.0011,0.0012,0.0013,0.0014,0.0015,0.0016,0.0017,0.0018,0.0019,0.0020,0.0022,0.0026,0.0028,0.0030,0.0040,0.0050,0.0060,0.0070,0.0090,0.0100,0.0150,0.0200,0.0500,0.1000,0.3000,1)

#ReplRate <- c(0.0000,0.0007,0.0022,0.0028)
time <- 5000

m  <- 0.0001596079
alfa <-2.038974

p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=side,meta=c("U","L")) # ,"L"

# Read simulations info and add it to Clusters data.frame 
# use it in case of broken simulations

# Clu <- data.frame()
# for(i in 1:nrow(p))
# {
#     Clu <- bind_rows(Clu,simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",time,nSimul,F,"N",p$meta[i],F))
#   
# }

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

# Last parameter to delete previous simulations
#
Clu <- data.frame()
Clu <- foreach(i=1:nrow(p),.combine='rbind') %dopar%
{
    simulNeutral_1Time(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",time,nSimul,T,"N",p$meta[i],T)
}

stopCluster(cl)

Clusters <-rbind(Clusters,Clu)
setwd(oldcd)

rm(p,cn,cl,Clu)

save.image()
```


## Calc Critical point and plots

```{r pcT5000_clu_side_256_meta16_disp26, eval=F,echo=F,message=T,warning=T}


m   <-round(0.0001596079,9)
alfa <-round(2.038974,5)
time <- 5000
nsp<-16

rl <- calcCritical_prob(Clusters,time,nsp,alfa,m) #Exclude Side=100

# Update table after recalculation of critical points
#rhoCritSide <- filter(rhoCritSide,DispersalDistance!=26.66 | ColonizationRate!=0.000159608 | MetaNsp!=16)
rhoCritSide <- rbind(rhoCritSide,rl$rCTs)
rhoCrit <- rbind(rhoCrit,rl$rCT)

# Save figures
#
plotCritical_Clusters(Clusters,time,nsp,alfa,m,rhoCritSide,150,T)

#
# Tables for paper
#
require(pander)
pandoc.table(filter(rhoCritSide,DispersalDistance==26.66,ColonizationRate==m, MetaNsp==64) %>% select(c(1,4:6)),round=5)

options("scipen"=100, "digits"=6)
pandoc.table(select(rhoCrit,c(6,1:5)) %>% arrange(ColonizationRate,desc(DispersalDistance),MetaNsp,MetaType)
             ,round=5)

# Calculation of the relative variation of each variable
#
senRhoCri <- filter(rhoCrit,ColonizationRate==round(0.0001596079,9),MetaNsp==64) %>% group_by(MetaType) %>% summarize(var="Dispersal",delta_pc=(max(pcrit) - min(pcrit))/max(pcrit), delta_var=(max(DispersalDistance) - min(DispersalDistance))/max(DispersalDistance),rv_var=delta_pc/delta_var)

senRhoCri <- bind_rows(senRhoCri, filter(rhoCrit,ColonizationRate==round(0.0001596079,9),DispersalDistance==26.66) %>% group_by(MetaType) %>% summarize(delta_pc=(max(pcrit) - min(pcrit))/max(pcrit), delta_var=(max(MetaNsp) - min(MetaNsp))/max(MetaNsp),rv_var=delta_pc/delta_var,var="MetaNsp"))

senRhoCri <- bind_rows(senRhoCri, filter(rhoCrit,MetaNsp==64,DispersalDistance==26.66) %>% group_by(MetaType) %>% summarize(delta_pc=(max(pcrit) - min(pcrit))/max(pcrit), delta_var=(max(ColonizationRate) - min(ColonizationRate))/max(ColonizationRate),rv_var=delta_pc/delta_var,var="Colonization"))

pandoc.table(senRhoCri,round=2)

```

With 16 species and logseries community the most abundant species have a nonzero probability to form a spanning cluster, if we take out neutral communities we can still calculate a critical point.



## Simulations to Time=20000 to plot spatial patterns (NOT DONE)

```{r gensimul_spat_256_64_meta30_T20000, eval=F,echo=F,message=T,warning=T}
setwd("Simul")


m =  0.0001
alfa=2.038974
side <- 256
nsp <- 64
nSimul <- 1

time<-      c(20000,  20000, 30000, 20000, 20000, 20000,  5000, 5000, 5000)
ReplRate <- c(0.0000,0.0001,0.0005,0.0010,0.0050,0.0100,0.1000,0.3000,1)

p <-expand.grid(disp=alfa,migr=m,repl=ReplRate,side=side,meta=c("U","L")) 
time <-rep(time, times=nrow(p)/length(time))
p <-cbind(p,time)

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

Clu <- data.frame()
Clu <- foreach(i=1:nrow(p),.combine='rbind') %dopar%
{
  simul_NeutralSAD(nsp,p$side[i],p$disp[i],p$migr[i],p$repl[i],"S",p$time[i],p$meta[i],F,2)
}

stopCluster(cl)

rm(cn,cl,Clu)

#save.image()

#
# Plot spatial patterns
#

ReplRate <- c(0.0000,0.0001,0.0005,0.0010,0.0050,0.0100,0.1000,0.3000,1)

ReplRate <- c(0.0000,0.0001,0.0005,0.0010)
ReplRate <- c(0.0000,0.0005,0.0010,0.0050)

#ReplRate <- c(0.1)
options("scipen"=0, "digits"=4)

# only the spanning species
plotNeutral_SpatPat(nsp,side,time,meta=c("U"),ReplRate,T)
setwd(oldcd)
ggsave("figs/SpatSpan_Repl_T5000_64_256_Unif.png", width=6,height=6,units="in",dpi=600)

setwd("Simul")
ReplRate <- c(0.0000,0.0013,0.0020,0.0050)
plotNeutral_SpatPat(nsp,side,time,meta=c("L"),ReplRate,T)
setwd(oldcd)
ggsave("figs/SpatSpan_Repl_T5000_64_256_Logser.png", width=6,height=6,units="in",dpi=600)

# All species
setwd("Simul")
plotNeutral_SpatPat(nsp,side,time,meta=c("U"),ReplRate,F)
setwd(oldcd)
ggsave("figs/SpatAllSp_Repl_T5000_64_256_Unif.png", width=6,height=6,units="in",dpi=600)

plotNeutral_SpatPat(nsp,side,time,meta=c("L"),ReplRate,F)


```


## Calculation of the Suvival Time of the most abundant species (Species=1) and density for side=512 time=5000 uniform metacomunity   (NOT DONE)

Survival of 1 = P(t) ~ t ^-delta
Number of 1 = N(t) ~ t^theta

To do this the model should be non saturated !!!!!!!!!!!!!!!

```{r survivalTimel512_64_U5_T5000, eval=F,echo=F,message=F,warning=F}

setwd("Simul")

# Ver Neutral_Model_BCI.Rmd por parametros
#
m =  0.1
alfa=2.038974
side <- 512
nsp <- 64
nSimul <- 5
ReplRate <- c(0,0.001,0.002,0.003,0.004,0.005,0.006,0.007,0.009,0.01,0.02,0.03,0.05,0.07,0.1,0.2,0.3,0.6,1)
time <- 20000
# loop con do paralell 

require(doParallel)
cn <-detectCores()
cl <- makeCluster(cn)
registerDoParallel(cl)

CT1 <- data.frame()

CT1 <- foreach(i=1:length(ReplRate),.combine='rbind') %dopar%
{
    simul_NeutralPlotTime(nsp,side,alfa,m,ReplRate[i],T,time,nSimul,"N")
}
stopCluster(cl)

rm(cn,cl)
for(i in 1:length(ReplRate)){
  kk <- simul_NeutralPlotTime(nsp,side,alfa,m,ReplRate[i],F,time,nSimul,"N")
}

# Correct CT add variable metatype
#CT <- mutate(CT,MetaType="U")
CT1$Time <- time
CT <- rbind(CT,CT1)

setwd(oldcd)

# Calculate averages by simulations 

require(dplyr)
require(ggplot2)
mct <- group_by(CT,Repl,MetaType) %>% summarize(meanRich = mean(meanRich),meanH=mean(meanH),
                                       TMaxH=mean(TMaxH),TMaxRich=mean(TMaxRich),
                                       MaxH=mean(MaxH),MaxRich=mean(MaxRich),
                                       meanEven=mean(meanEven))

# Plots of all simulations and averages H & Richness


plot_simul_timeRH(CT,mct)

rm(kk,CT1)
save.image()

```
